// Superintendent101 Prisma Schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String       @id @default(cuid())
  email           String       @unique
  username        String       @unique
  passwordHash    String?
  name            String?
  avatarUrl       String?
  bio             String?
  location        String?
  skills          String[]
  yearsExperience Int?
  role            Role         @default(MEMBER)
  isMentor        Boolean      @default(false)
  mentorBio       String?
  hourlyRate      Decimal?
  subscription    Subscription @default(FREE)
  trialEndsAt     DateTime?
  stripeCustomerId String?
  stripeSubId      String?
  walletAddress    String?  // Base network wallet address
  // Integration tokens (encrypted at rest)
  notionToken     String?
  notionDbId      String?
  betaTester      Boolean      @default(false)   // free for life — Stripe webhook skips these
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  projects         Project[]
  posts            Post[]
  comments         Comment[]
  likes            Like[]
  messagesSent     Message[]  @relation("SentMessages")
  messagesReceived Message[]  @relation("ReceivedMessages")
  bookings         Booking[]  @relation("MentorBookings")
  audioLogs        AudioLog[]
  jobSites         JobSite[]
  apiUsageLogs     ApiUsageLog[]
  dailyLogs        DailyLog[]
  companyMemberships CompanyMember[]
}

enum Role {
  MEMBER
  MENTOR
  ADMIN
}

enum Subscription {
  FREE
  PRO
  DUST_LOGS
}

model Project {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String?
  location    String?
  type        String?
  sqft        Int?
  status      ProjectStatus @default(ACTIVE)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime      @default(now())
  dailyLogs   DailyLog[]
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  COMPLETED
  ON_HOLD
}

model Post {
  id        String   @id @default(cuid())
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  tags      String[]
  type      PostType @default(DISCUSSION)
  viewCount Int      @default(0)
  createdAt DateTime @default(now())
  comments  Comment[]
  likes     Like[]
}

enum PostType {
  DISCUSSION
  LESSON_LEARNED
  SAFETY_OBSERVATION
  TIP
  STORY
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  createdAt DateTime @default(now())
}

model Like {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  content    String   @db.Text
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
}

model Booking {
  id              String        @id @default(cuid())
  mentorId        String
  mentor          User          @relation("MentorBookings", fields: [mentorId], references: [id])
  clientId        String
  scheduledAt     DateTime
  durationMinutes Int           @default(60)
  notes           String?
  hourlyRate      Decimal
  totalPrice      Decimal
  status          BookingStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  escrow          Escrow?
}

model Escrow {
  id         String       @id @default(cuid())
  bookingId  String       @unique
  booking    Booking      @relation(fields: [bookingId], references: [id])
  txHash     String?
  amount     Decimal
  fee        Decimal
  status     EscrowStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  settledAt  DateTime?
}

enum EscrowStatus {
  PENDING
  FUNDED
  RELEASED
  REFUNDED
  DISPUTED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

model AudioLog {
  id          String              @id @default(cuid())
  userId      String
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  audioUrl    String
  transcript  String?             @db.Text
  status      TranscriptionStatus @default(PENDING)
  projectName String?
  address     String?
  tags        String[]
  duration    Int?
  createdAt   DateTime            @default(now())
}

enum TranscriptionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model JobSite {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  address      String?
  permitNumber String?
  webPortalId  String?
  portalType   String?
  jobType      String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ApiUsageLog {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  service       String   // "whisper" | "gpt4o"
  action        String   // "transcribe" | "structure"
  inputTokens   Int?
  outputTokens  Int?
  fileSizeBytes Int?
  costUsd       Decimal  @db.Decimal(10, 6)
  projectName   String?
  createdAt     DateTime @default(now())
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  email     String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model DailyLog {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId     String?
  project       Project? @relation(fields: [projectId], references: [id])
  date          DateTime @db.Date
  weather       String   @default("")
  crewCounts    Json     @default("{}")   // { "Framers": 4, "Electricians": 2 }
  workPerformed String   @db.Text @default("")
  deliveries    String   @db.Text @default("")
  inspections   String   @db.Text @default("")
  issues        String   @db.Text @default("")
  safetyNotes   String   @db.Text @default("")
  photoUrls     String[] @default([])
  signatureUrl  String?
  transcript    String?  @db.Text        // raw voice transcript for reference
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ─── Company Groups (white-label client management) ────────────────────────────

model Company {
  id               String          @id @default(cuid())
  name             String
  slug             String          @unique   // used in URLs / API references
  logoUrl          String?
  brandColor       String          @default("#2563eb")
  contactEmail     String?
  seats            Int             @default(10)   // max members allowed
  active           Boolean         @default(true)
  grantsBetaTester Boolean         @default(false) // all members get free-for-life
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  members      CompanyMember[]
}

model CompanyMember {
  id          String      @id @default(cuid())
  companyId   String
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        CompanyRole @default(MEMBER)
  joinedAt    DateTime    @default(now())

  @@unique([companyId, userId])
}

enum CompanyRole {
  OWNER
  MEMBER
}
